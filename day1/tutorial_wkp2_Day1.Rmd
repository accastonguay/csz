---
title: "Workshop on modelling and mapping suitability of climate-sensitive zoonotic diseases"
date: "2023-07-12"
output: html_document
---

Overview of Day 1 training
================

## What are we going to learn?

Today:   

1. [R Overview and installation](#installation)
2. [Understanding R Studio](#understanding-r-studio)
3. [Assigning variables](#assigning-variables)
4. [Data types](#data-types)
5. [Data structures](#data-structures)
6. [Packages](#packages)
7. [Working with spatial data](#working-with-spatial-data)

Tomorrow:

1. Species distribution modelling
2. Structural equation modelling
3. Climate change scenarios
4. Model uncertainty and sensitivity

## R + RStudio

The [R programming language](https://cran.r-project.org/) is a language
used for calculations, statistics, visualisations and many more data
science tasks.

[RStudio](https://rstudio.com/products/rstudio/) is an open source
Integrated Development Environment (IDE) for R, which means it provides
many features on top of R to make it easier to write and run code.

## Installation

For this workshop, you need to have both R and RStudio installed
([installation
instructions](https://github.com/uqlibrary/technology-training/blob/master/R/Installation.md#r--rstudio-installation-instructions)).



## Understanding R Studio

-   Console: interactive coding
-   Script: write code first and then run chunks of code
-   Additional panels: visualise plots, install packages, view environment

![Rstudio](C:/Users/uqachare/OneDrive - The University of Queensland/Pictures/Screenshot 2023-07-10 215558.png)

## Assigning variables

When working with R, we need to assign values we want to work with to variables. In R this is typically done with the `<-` operator. The left term (`var`) is the variable and the term on the right (`1`) is the value assigned

```{r}
# assign a single value
var <- 1
var
```

## Data types

In R we have 4 main types (classes) of data:

1.    numeric (e.g., `2.21`)
2.    integer (e.g., `2`)
3.    character (using `''` or `""`, e.g., `"hello world"`)
4.    logical (`TRUE` or `FALSE`)

You can inspect the type of data with the `class()` function:

```{r}
var <- "hello world"
class(var)
```

## Data structures

- vectors
- dataframes
- lists
- matrix
- arrays


```{r}
# assign a vector
vec <- c(1,2,3,4)
vec

# assign a dataframe
df <- data.frame(col1 = c(1,2,3,4),
                 col2 = c("a","b","c","d"))
df
```

## Packages

Packages are a group of functions that add functionalities to R and RStudio but that require to be loaded before use.

You can install a package with the command `install.packages("package")` or using the user interface with the Packages tab on the right panel. To use a function in a package, the package need to be loaded for each new active session with the command `library(package)`.

### Exercise

1. To work with spatial data we will use the `terra` package. Install `terra` with 

```{r, eval = FALSE}
install.packages("terra")
``` 

2. Then we need to load `terra` with 

```{r, eval = FALSE} 
library(terra)
```

3. Open the documentation page for the `terra` package with `?`

```{r, eval = FALSE}
?terra
```

4. Look at the documentation to explore specific `terra` functions, for instance `rasterize()` 

```{r, eval = FALSE}
?rasterize
```

5. Install multiple packages that we will need for modelling by using a vector of package names

```{r, eval = FALSE}
install.packages(c("bangladesh", # maps of Bangladesh
                   "sf", # Work with vector data
                   "raster", # raster data manipulation
                   "dplyr", # data manipulation 
                   "dismo", # species distribution modelling
                   "rgbif", # species occurrence data
                   "lavaan", # latent variable analysis and SEM
                   "lavaanPlot") # Additional functionalities for SEM)
```

## Working with spatial data

### Data structure for spatial data

#### 1. Rasters
-   Grid with determined by extent and size (rows, columns)
-   Grid cells all have the same resolution
-   Metadata, e.g., resolution, extent, size, coordinate reference system. name of layer (layers if more than one).

#### 2. Vectors: 

-   Points, lines and polygons
-   Each spatial entity has its location (e.g., lon, lat) or boundary
-   Metadata include coordinate reference system



![Wegmann, CC BY-SA 3.0 <https://creativecommons.org/licenses/by-sa/3.0>, via Wikimedia Commons](https://upload.wikimedia.org/wikipedia/commons/b/b8/Raster_vector_tikz.png)



### Reading and writing (spatial) data

-   Reading spatial data: You need to read a file first to process or visualise it. With the `terra` package, a raster file can be read with the command `rast("file_path")` and a vector file can be read with `vect("file_path")` or `st_read("file_path")`. Remember to assign the data to a variable to be able to use it, e.g., `var <- rast("file_path")`.  

-   Reading non-spatial tabular data can be read with different functions depending on the data type, e.g., `read.table()` for .txt file, `read.csv()` for comma separated values (CSV) or `readxl()` for excel files

-   Writing spatial data: A raster file that was modified in R can be saved with `writeRaster(variable, "file_path")`. Make sure metadata is correct before saving a file.

### Understanding working directories

Getting to know your working directory, i.e., where your R file is located and where it will look to read and write files
 
```{r, eval=FALSE}
getwd()
```

You can change your working directory with the command 

``` {r}
setwd("./")
```

### Manipulating spatial data

#### Rasters:

-   Crop
-   mask
-   resample

#### Vectors:

-   Filter
-   Rasterize
-   Clip
-   Buffer

## Exercise
Generally we want to stick to one type of spatial data to make it easier to work with, for instance using only raster layers with the same size, resolution and extent. Some times we obtain data in both vector and raster formats and need to process the data in order to have all datasets in the same format.

1. Read raster
2. Read vector
3. Crop raster to vector extent
4. Read non-spatial csv file and convert it to vector 


#### 1. Read the bioclimatic raster data from [WorldClim](https://www.worldclim.org/data/bioclim.html) online repository and inspect the file

```{r, echo = FALSE}
setwd("C:/Users/uqachare/OneDrive - The University of Queensland/Documents/WB project/bangladesh_model/r_codes/tutorial_workshop2")
```

```{r}
library(terra)

bc1 <- rast("./data/wc2.1_5m_bio_1.tif")
```

Then you can inspect the metadata: 

```{r}
bc1
```

Visualise the layer(s) of the raster with the `plot` function:
```{r} 
plot(bc1)
``` 

#### 2. Read and plot vector

Load the `bangladesh` library and inspect the vector dataframe

```{r}
library(bangladesh)
head(map_upazila)
```

Notice that, as opposed to a raster, vector data are organised as a dataframe. 
Plot the geometries and specify the column "Upazila" to be shown

```{r}
plot(map_upazila['Upazila'])
```

#### 3. Crop raster to the geographical extent of Bangladesh with the `crop()` function. 

Values outside of the area of interest can be masked (converted to NA) with the `mask = TRUE` argument.

```{r}
cropped_bc1 <- crop(bc1, map_country, mask = TRUE)
plot(cropped_bc1)
plot(map_country['geometry'], add = T)
```

#### 4. Convert a point dataset to raster in three step: 

1. Read non-spatial data from FAO EMPRES-i+ (https://empres-i.apps.fao.org/) as dataframe 
2. Convert dataframe to spatial data structure using the `sf` package    
3. Convert polygon data to raster


```{r}
empres_data <- read.csv("data/empress_i_AIV.csv")
head(empres_data)
```

#### 5. Only keep data for Bangladesh using the `filter` function

```{r}
empres_bgd <- dplyr::filter(empres_data, Country == 'Bangladesh')
head(empres_bgd)
```

#### 6. Convert dataframe to spatial data using the coordinate columns `latitude` and `longitude` with the `sf` package.

```{r}
library(sf)
sp_empres_bgd <- st_as_sf(empres_bgd, coords = c("longitude", "latitude"), crs = 4326)
head(sp_empres_bgd)
```

plot points on map

```{r}
plot(map_country['geometry'])
plot(sp_empres_bgd['geometry'], add = T, col = 'red', cex = 0.5, pch = 16)
```

#### 7. Rasterize infection cases points based on raster file with `terra` package

```{r}
r_AIV <- rasterize(sp_empres_bgd, cropped_bc1)
names(r_AIV) <- "AIV_cases"
plot(r_AIV)
plot(map_country['geometry'], add = T)
plot(sp_empres_bgd['geometry'], add = T, col = 'red', cex = 0.5, pch = 16)
```

Plot the two raster maps side-by-side

```{r}
rasters <- c(cropped_bc1,r_AIV)
plot(rasters)
```